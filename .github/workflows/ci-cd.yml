name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false  # Queue instead of canceling

env:
  NODE_VERSION: '20'
  DOTNET_VERSION: '9.0.x'

jobs:
  # Build jobs run in parallel
  # ICP jobs commented out - ICP canisters need deployment to network, not just build
  # See apps/icp/README.md for manual deployment instructions
  backend:
    name: Build Backend
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: Restore dependencies
      run: dotnet restore apps/backend/TreffServices.sln
    
    - name: Build
      run: dotnet build apps/backend/TreffServices.sln --no-restore --configuration Release
    
    - name: Test
      run: dotnet test apps/backend/TreffServices.sln --no-build --configuration Release --verbosity normal

  frontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Build frontend
      run: npm run build --workspace=apps/frontend
      env:
        CI: false  # Don't treat warnings as errors
    
    # Skip tests - Jest has ESM issues with axios in CI
    # - name: Test frontend
    #   run: npm run test --workspace=apps/frontend
    #   env:
    #     CI: true

  # ICP build commented out - requires deployment to network, not just build
  # icp:
  #   runs-on: ubuntu-latest
  #   
  #   steps:
  #   - uses: actions/checkout@v4
  #   
  #   - name: Setup Node.js
  #     uses: actions/setup-node@v4
  #     with:
  #       node-version: ${{ env.NODE_VERSION }}
  #       cache: 'npm'
  #   
  #   - name: Install DFX
  #     uses: dfinity/setup-dfx@main
  #   
  #   - name: Install dependencies
  #     run: npm ci
  #   
  #   - name: Build ICP
  #     working-directory: ./apps/icp
  #     run: |
  #       dfx start --background --clean
  #       npm run build

  # Deploy infrastructure only after all builds pass
  deploy-infrastructure:
    name: Deploy Infrastructure
    needs: [backend, frontend]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    environment: production
    permissions:
      id-token: write   # Required for OIDC
      contents: read    # Required to checkout code
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: infrastructure/package-lock.json
    
    - name: Configure AWS credentials (OIDC)
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ vars.AWS_ROLE_ARN }}
        aws-region: ${{ vars.AWS_REGION }}
        role-session-name: GitHubActions-Infrastructure
    
    - name: Install CDK dependencies
      working-directory: ./infrastructure
      run: npm ci
    
    - name: Build CDK
      working-directory: ./infrastructure
      run: npm run build
    
    - name: CDK Diff
      working-directory: ./infrastructure
      run: npm run diff
      env:
        MYSQL_ROOT_PASSWORD: ${{ secrets.MYSQL_ROOT_PASSWORD }}
        MYSQL_PASSWORD: ${{ secrets.MYSQL_PASSWORD }}
        FRONTEND_BUCKET_NAME: ${{ vars.FRONTEND_BUCKET_NAME }}
        ASSETS_BUCKET_NAME: ${{ vars.ASSETS_BUCKET_NAME }}
    
    - name: CDK Deploy
      id: cdk-deploy
      working-directory: ./infrastructure
      run: |
        set -x  # Enable verbose output
        npm run deploy -- --require-approval never --verbose 2>&1 | tee deploy.log
        
        # Extract outputs from CDK deployment
        EC2_IP=$(grep -o 'EC2PublicIP = [0-9.]*' deploy.log | cut -d' ' -f3)
        CLOUDFRONT_URL=$(grep -o 'CloudFrontURL = https://[^[:space:]]*' deploy.log | cut -d' ' -f3)
        DISTRIBUTION_ID=$(grep -o 'CloudFrontDistributionId = [^[:space:]]*' deploy.log | cut -d' ' -f3)
        BACKEND_URL=$(grep -o 'BackendURL = https://[^[:space:]]*' deploy.log | cut -d' ' -f3)
        
        echo "ec2_ip=$EC2_IP" >> $GITHUB_OUTPUT
        echo "cloudfront_url=$CLOUDFRONT_URL" >> $GITHUB_OUTPUT
        echo "distribution_id=$DISTRIBUTION_ID" >> $GITHUB_OUTPUT
        echo "backend_url=$BACKEND_URL" >> $GITHUB_OUTPUT
      env:
        MYSQL_ROOT_PASSWORD: ${{ secrets.MYSQL_ROOT_PASSWORD }}
        MYSQL_PASSWORD: ${{ secrets.MYSQL_PASSWORD }}
        FRONTEND_BUCKET_NAME: ${{ vars.FRONTEND_BUCKET_NAME }}
        ASSETS_BUCKET_NAME: ${{ vars.ASSETS_BUCKET_NAME }}
    
    - name: Generate Deployment Summary
      run: |
        cat >> $GITHUB_STEP_SUMMARY << 'EOF'
        # ðŸš€ Treff Application Deployed Successfully!
        
        ## ðŸ“ Application Endpoints
        
        | Service | URL |
        |---------|-----|
        | ðŸŒ **Frontend** | ${{ steps.cdk-deploy.outputs.cloudfront_url }} |
        | ðŸ”Œ **Backend API** | ${{ steps.cdk-deploy.outputs.backend_url }} |
        
        ## ðŸ–¥ï¸ Server Access
        
        **EC2 Instance IP:** `${{ steps.cdk-deploy.outputs.ec2_ip }}`
        
        **SSH Command:**
        ```bash
        ssh -i ~/.ssh/your-key.pem ubuntu@${{ steps.cdk-deploy.outputs.ec2_ip }}
        ```
        
        > âš ï¸ **Note:** Replace `your-key.pem` with your actual EC2 key pair name.
        
        ## ðŸ“¦ Resources
        
        - **CloudFront Distribution ID:** `${{ steps.cdk-deploy.outputs.distribution_id }}`
        - **Frontend Bucket:** `${{ vars.FRONTEND_BUCKET_NAME }}`
        - **Assets Bucket:** `${{ vars.ASSETS_BUCKET_NAME }}`
        - **Region:** `${{ vars.AWS_REGION }}`
        
        ## ðŸ” Quick Health Check
        
        Test the backend API:
        ```bash
        curl ${{ steps.cdk-deploy.outputs.backend_url }}/api/health
        ```
        
        ---
        *Deployment completed at $(date -u +"%Y-%m-%d %H:%M:%S UTC")*
        EOF
    
    outputs:
      ec2_ip: ${{ steps.cdk-deploy.outputs.ec2_ip }}
      cloudfront_url: ${{ steps.cdk-deploy.outputs.cloudfront_url }}
      distribution_id: ${{ steps.cdk-deploy.outputs.distribution_id }}
      backend_url: ${{ steps.cdk-deploy.outputs.backend_url }}

  deploy-backend:
    name: Deploy Backend
    needs: [deploy-infrastructure]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    environment: production
    permissions:
      id-token: write
      contents: read
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: Build and Publish Backend
      working-directory: ./apps/backend/WebApi
      run: |
        dotnet publish -c Release -o ./publish
        cd publish
        tar -czf backend.tar.gz *
    
    - name: Configure AWS credentials (OIDC)
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ vars.AWS_ROLE_ARN }}
        aws-region: ${{ vars.AWS_REGION }}
        role-session-name: GitHubActions-Backend
    
    - name: Get EC2 Instance ID
      id: get-instance
      run: |
        INSTANCE_ID=$(aws ec2 describe-instances \
          --filters "Name=tag:Name,Values=TreffInfrastructureStack/TreffEC2Instance" \
          --query "Reservations[0].Instances[0].InstanceId" \
          --output text)
        echo "instance_id=$INSTANCE_ID" >> $GITHUB_OUTPUT
    
    - name: Upload Backend to S3 (temporary storage)
      working-directory: ./apps/backend/WebApi/publish
      run: |
        aws s3 cp backend.tar.gz s3://${{ vars.DEPLOYMENT_BUCKET_NAME }}/backend.tar.gz
    
    - name: Deploy Backend to EC2 via SSM
      run: |
        aws ssm send-command \
          --instance-ids ${{ steps.get-instance.outputs.instance_id }} \
          --document-name "AWS-RunShellScript" \
          --parameters 'commands=[
            "aws s3 cp s3://${{ vars.DEPLOYMENT_BUCKET_NAME }}/backend.tar.gz /tmp/backend.tar.gz",
            "sudo systemctl stop treff-backend || true",
            "sudo rm -rf /var/www/treff-backend/*",
            "sudo tar -xzf /tmp/backend.tar.gz -C /var/www/treff-backend/",
            "sudo chown -R www-data:www-data /var/www/treff-backend/",
            "sudo systemctl enable treff-backend",
            "sudo systemctl start treff-backend",
            "rm /tmp/backend.tar.gz"
          ]' \
          --output text

  deploy-frontend:
    name: Deploy Frontend
    needs: [deploy-infrastructure]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    environment: production
    permissions:
      id-token: write
      contents: read
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Build Frontend
      working-directory: ./apps/frontend
      run: npm run build
      env:
        CI: false  # Don't treat warnings as errors
        REACT_APP_API_URL: ${{ vars.BACKEND_API_URL }}
        REACT_APP_SIGNALR_URL: ${{ vars.BACKEND_API_URL }}
    
    - name: Configure AWS credentials (OIDC)
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ vars.AWS_ROLE_ARN }}
        aws-region: ${{ vars.AWS_REGION }}
        role-session-name: GitHubActions-Frontend
    
    - name: Deploy to S3
      working-directory: ./apps/frontend/build
      run: |
        aws s3 sync . s3://${{ vars.FRONTEND_BUCKET_NAME }}/ --delete
    
    - name: Invalidate CloudFront Cache
      run: |
        aws cloudfront create-invalidation \
          --distribution-id ${{ vars.CLOUDFRONT_DISTRIBUTION_ID }} \
          --paths "/*"
  
  # ICP deployment commented out - requires mainnet credentials and cycles
  # deploy-icp:
  #   needs: [icp]
  #   if: github.ref == 'refs/heads/main' && github.event_name == 'push'
  #   runs-on: ubuntu-latest
  #   environment: production
  #   
  #   steps:
  #   - uses: actions/checkout@v4
  #   
  #   - name: Setup Node.js
  #     uses: actions/setup-node@v4
  #     with:
  #       node-version: ${{ env.NODE_VERSION }}
  #       cache: 'npm'
  #   
  #   - name: Install DFX
  #     uses: dfinity/setup-dfx@main
  #   
  #   - name: Install dependencies
  #     run: npm ci
  #   
  #   - name: Deploy ICP to Mainnet
  #     working-directory: ./apps/icp
  #     run: |
  #       echo "${{ secrets.DFX_IDENTITY }}" > identity.pem
  #       dfx identity import github-actions identity.pem
  #       dfx identity use github-actions
  #       dfx deploy --network ic
  #     env:
  #       DFX_IDENTITY: ${{ secrets.DFX_IDENTITY }}